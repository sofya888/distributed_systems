# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞
PROJECT_NAME = calculator
VERSION = 1.0

# –ö–æ–º–ø–∏–ª—è—Ç–æ—Ä –∏ —Ñ–ª–∞–≥–∏
CC = gcc
CFLAGS = -Wall -Wextra -std=c99 -Iinclude
LDFLAGS = -lm

# –î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
SRC_DIR = src
OBJ_DIR = obj
INC_DIR = include
BIN_DIR = bin

# –¶–µ–ª–∏
TARGET = $(BIN_DIR)/$(PROJECT_NAME)

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤
SOURCES = $(wildcard $(SRC_DIR)/*.c)
OBJECTS = $(SOURCES:$(SRC_DIR)/%.c=$(OBJ_DIR)/%.o)
HEADERS = $(wildcard $(INC_DIR)/*.h)

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–±–æ—Ä–∫–∏
DEBUG ?= 0
ifeq ($(DEBUG),1)
CFLAGS += -g -O0 -DDEBUG
else
CFLAGS += -O2 -DNDEBUG
endif

# –û—Å–Ω–æ–≤–Ω–∞—è —Ü–µ–ª—å
all: $(TARGET)

# –°–±–æ—Ä–∫–∞ –∏—Å–ø–æ–ª–Ω—è–µ–º–æ–≥–æ —Ñ–∞–π–ª–∞
$(TARGET): $(OBJECTS) | $(BIN_DIR)
	$(CC) $(CFLAGS) -o $@ $(OBJECTS) $(LDFLAGS)
	@echo "‚úÖ $(PROJECT_NAME) v$(VERSION) —É—Å–ø–µ—à–Ω–æ —Å–æ–±—Ä–∞–Ω!"

# –ö–æ–º–ø–∏–ª—è—Ü–∏—è –æ–±—ä–µ–∫—Ç–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
$(OBJ_DIR)/%.o: $(SRC_DIR)/%.c $(HEADERS) | $(OBJ_DIR)
	$(CC) $(CFLAGS) -c $< -o $@
	@echo "üî® –°–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω: $<"

# –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
$(BIN_DIR) $(OBJ_DIR):
	mkdir -p $@

# –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –º–µ–∂–¥—É —Ñ–∞–π–ª–∞–º–∏
$(OBJ_DIR)/main.o: $(INC_DIR)/calculator.h $(INC_DIR)/utils.h
$(OBJ_DIR)/calculator.o: $(INC_DIR)/calculator.h
$(OBJ_DIR)/utils.o: $(INC_DIR)/utils.h

# –û—á–∏—Å—Ç–∫–∞
clean:
	rm -rf $(OBJ_DIR) $(BIN_DIR)
	@echo "üßπ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

# –ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞
rebuild: clean all

# –ó–∞–ø—É—Å–∫
run: $(TARGET)
	@echo "üöÄ –ó–∞–ø—É—Å–∫ $(PROJECT_NAME)..."
	@echo "========================================"
	./$(TARGET)

# –û—Ç–ª–∞–¥–æ—á–Ω–∞—è —Å–±–æ—Ä–∫–∞
debug:
	@$(MAKE) DEBUG=1

# –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑
analyze: CFLAGS += -fanalyzer
analyze: clean all

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∏–ª—è –∫–æ–¥–∞
style:
	@echo "üìù –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∏–ª—è –∫–æ–¥–∞..."
	@if command -v clang-format >/dev/null 2>&1; then \
		clang-format -n $(SOURCES) $(HEADERS); \
	else \
		echo "clang-format –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"; \
	fi

# –°–±–æ—Ä–∫–∞ —Å —Ä–∞–∑–Ω—ã–º–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è–º–∏
release: CFLAGS += -O3 -march=native
release: clean all

size-optimized: CFLAGS += -Os
size-optimized: clean all

# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ
info:
	@echo "üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ:"
	@echo "   –ü—Ä–æ–µ–∫—Ç: $(PROJECT_NAME) v$(VERSION)"
	@echo "   –ö–æ–º–ø–∏–ª—è—Ç–æ—Ä: $(CC)"
	@echo "   –§–ª–∞–≥–∏: $(CFLAGS)"
	@echo "   –ò—Å—Ö–æ–¥–Ω–∏–∫–∏: $(words $(SOURCES)) —Ñ–∞–π–ª–æ–≤"
	@echo "   –ó–∞–≥–æ–ª–æ–≤–∫–∏: $(words $(HEADERS)) —Ñ–∞–π–ª–æ–≤"
	@echo "   –¶–µ–ª—å: $(TARGET)"

.PHONY: all clean rebuild run debug analyze style info release size-optimized
